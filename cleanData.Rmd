---
title: "ConsumerComplaintDatabase"
author: "mspcvsp"
date: "04/04/2015"
output: html_document
---
library(caret)

```{r downloadData}
fileURL <- paste0('https://data.consumerfinance.gov/api/views',
                  '/x94z-ydhh/rows.csv?accessType=DOWNLOAD')

if (is.na(file.info("./Data")[1,"isdir"])) {
    dir.create("./Data")
    
  download.file(fileURL, destfile="./Data/rows.csv", method="curl")
}

complaintData <- read.csv("./Data/rows.csv",
                          header=TRUE,
                          stringsAsFactors=FALSE)

# Transform the variable names to lower case
colnames(complaintData) <- tolower(colnames(complaintData))

# Remove '.' from variable names
colnames(complaintData) <- gsub('\\.','',colnames(complaintData))

# Remove rows where either the complaint issue is missing
nrowsBefore <- nrow(complaintData)
complaintData <- complaintData[which(complaintData$issue != ""),]
nrowsAfter <- nrow(complaintData)
percentIssueMissing <- 100 * (1 - (nrowsAfter / nrowsBefore))

# Transform complaint issue to lower case
complaintData$issue <- tolower(complaintData$issue)

# Remove punctuation from complaint issues
# http://www.regular-expressions.info/posixbrackets.html
complaintData$issue <- sub("[[:punct:]]", " ", complaintData$issue)
complaintData$issue <- sub("\\s+"," ",complaintData$issue)

# Aggregate complaint issues
bankingIssue <-
  grepl("deposits and withdrawals", complaintData$issue) |
  grepl("disclosure verification of debt", complaintData$issue) |
  grepl("making receiving payments, sending money", complaintData$issue) |
  grepl("money was not available when promised", complaintData$issue) |
  grepl("taking out the loan or lease", complaintData$issue) |
  grepl("applied for loan did not receive money", complaintData$issue) |
  grepl("convenience checks", complaintData$issue) |
  grepl("adding money", complaintData$issue) |
  grepl("lost or stolen money order", complaintData$issue) |
  grepl("cash advance", complaintData$issue) |
  grepl("lost or stolen check", complaintData$issue) |
  grepl("shopping for a line of credit", complaintData$issue) |
  grepl("incorrect exchange rate", complaintData$issue) |
  grepl("overdraft savings or rewards features", complaintData$issue)
  
communicationIssue <-
  grepl("advertising marketing or disclosures", complaintData$issue) |
  grepl("taking threatening an illegal action" , complaintData$issue) |
  grepl("disclosures", complaintData$issue) |
  grepl("account terms and changes", complaintData$issue)

creditIssue <-
  grepl("incorrect information on credit report", complaintData$issue) |
  grepl("unable to get credit report credit score", complaintData$issue) |
  grepl("credit reporting company s investigation", complaintData$issue) |
  grepl("credit monitoring or identity protection", complaintData$issue) |
  grepl("credit reporting", complaintData$issue) |
  grepl("bankruptcy", complaintData$issue)

customerServiceIssue <-
  grepl("billing disputes", complaintData$issue) |
  grepl("arbitration", complaintData$issue) |
  grepl("charged bank acct wrong day or amt", complaintData$issue)

debtCollectionIssue <-
  grepl("cont d attempts collect debt not owed", complaintData$issue) |
  grepl("problems when you are unable to pay", complaintData$issue) |
  grepl("problems caused by my funds being low", complaintData$issue) |
  grepl("delinquent account", complaintData$issue) |
  grepl("lender repossessed or sold the vehicle", complaintData$issue) |
  grepl("repaying your loan", complaintData$issue) |
  grepl("collection practices", complaintData$issue) |
  grepl("collection debt dispute", complaintData$issue) |
  grepl("communication tactics", complaintData$issue) |
  grepl("can t repay my loan", complaintData$issue) |
  grepl("lender damaged or destroyed property", complaintData$issue) |
  grepl("lender sold the property", complaintData$issue) |
  grepl("lender damaged or destroyed vehicle", complaintData$issue)

feeIssue <- 
  grepl("cash advance fee", complaintData$issue) |
  grepl("other fee", complaintData$issue) |
  grepl("excessive fees", complaintData$issue) |
  grepl("overlimit fee", complaintData$issue) |
  grepl("fees", complaintData$issue)
  
financialCrimeIssue <- 
  grepl("fraud or scam", complaintData$issue) |
  grepl("false statements or representation", complaintData$issue)

mortgageIssue <-
  grepl("loan servicing  payments, escrow account", complaintData$issue) |
  grepl("loan modification collection,foreclosure", complaintData$issue) |
  grepl("settlement process and costs", complaintData$issue) |
  grepl("managing the loan or lease", complaintData$issue) |
  grepl("dealing with my lender or servicer", complaintData$issue) |
  grepl("sale of account", complaintData$issue)

privacyIssue <-
  grepl("improper contact or sharing of info", complaintData$issue)
  
unique(complaintData[!(bankingIssue |
                       communicationIssue | 
                       creditIssue |
                       customerServiceIssue |
                       debtCollectionIssue |
                       feeIssue |
                       financialCrimeIssue |
                       mortgageIssue |
                       privacyIssue), c("issue")])
```

# http://stackoverflow.com/questions/13610074/is-there-a-rule-of-thumb-for-how-to-divide-a-dataset-into-training-and-validatio
