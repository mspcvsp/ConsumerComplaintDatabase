---
title: "CFPB Consumer Complaint Database Exploratory Data Analysis"
author: mspcvsp
date: 05/01/15
output:
  ioslides_presentation:
    smaller: true
    css: styles.css
---

## Introduction
```{r setupEnvironment, echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE}
source("./dataCleaning.R")
source("./dataAnalysis.R")
set.seed(58978160)

dataDirectory <- "./Data"
analyticDataPath <- "./AnalyticData"
maximumPercentMissing <- 10.0

if (is.na(file.info(dataDirectory)[1,"isdir"])) {
    downloadData(dataDirectory)
}

if (is.na(file.info(file.path(analyticDataPath,
                              "/trainingData.csv"))[1,"size"])) {
    createAnalyticDataset(dataDirectory,
                          maximumPercentMissing,
                          analyticDataPath)
}

trainingData <- loadAnalyticData(analyticDataPath,
                                 "trainingData.csv")

validationData <- loadAnalyticData(analyticDataPath,
                                   "validationData.csv")

testData <- loadAnalyticData(analyticDataPath,
                             "testData.csv")

dbDataStatistics <- loadDataStatistics(analyticDataPath)

dbVariables <- initializeVariables(dbDataStatistics)
```
   
- [Consumer Financial Protection Bureau (CFPB)](http://www.consumerfinance.gov/)
[Consumer Complaint Database](https://catalog.data.gov/dataset/consumer-complaint-database)
    * Number of complaints: `r dbDataStatistics$numberobservations`  
    * Number of variables: `r length(dbVariables)`  
    * Number of companies: `r dbDataStatistics$numbercompanies`  
    * Number of unique complaint issues: `r dbDataStatistics$numberissues`
    * Data retrieved from [Data.gov](https://www.data.gov/)  
  
- Topics covered in this presentation
    * Data cleaning
    * Visualization of state-level statistics via [chroopleths](https://github.com/trulia/choroplethr)
    * Plotting zipcode-level statistics using the [ggmap package](http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf)

## Data Cleaning
```{r dataCleaning, echo=FALSE}
numCleanObservations <- nrow(trainingData) +
                        nrow(validationData) +
                        nrow(testData)

percentDataRemoved <-
    round(100*(dbDataStatistics$numberobservations - numCleanObservations) / 
          dbDataStatistics$numberobservations,1)
```
- Transform the variable names to lower case  
- Remove '.' from variale names  
- Exclude data from U.S. territories  
- Apply a maximum percent missing threshold to remove partial observations  
- Remove whitespace from the company type  
- For each database variable:  
    * Transform to lower case  
    * Remove apostrophe (e.g. change cont'd to contd)
    * Remove punctuation  
    * Replace multiple spaces with a single space  
  
## Data Cleaning (cont.)
- Remove white space from the company type  
- Aggregate the complaint issues into 
`r length(levels(trainingData$issuecategory))` categories  
- Remove the "other" category  
- Append city, state, latitude, & lognitude from the [zipcode R package](https://jeffreybreen.wordpress.com/2011/01/05/cran-zipcode/)  
- Add a companyid variable  
- Convert date variables  
- Convert factor variables  
- Percentage of data removed during data cleaning: `r percentDataRemoved`%  

## Percentage of Missing Data
```{r initializePercentMissingTable, echo=FALSE}
percentMissingTableData <- initializePercentMissingDataTable(dbDataStatistics)
```
- Results suggest `r sum(percentMissingTableData[,2] > maximumPercentMissing)`
variables exceed the maximum percentage of missing data threshold of
`r maximumPercentMissing` %.  
  
```{r displayPercentMissingTable, echo=FALSE, results='asis'}
library(xtable)
# Technical references:
# -------------------
# http://stackoverflow.com/questions/20200082/formatting-html-table-in-r
#
# http://stackoverflow.com/questions/21291762/
#   css-how-to-define-a-class-for-table-to-control-the-style-of-table-rows
#
# http://www.w3schools.com/css/css_table.asp
#
# http://cssmenumaker.com/blog/stylish-css-tables-tutorial
#
# http://stackoverflow.com/questions/5430338/
#   remove-data-frame-row-names-when-using-xtable
#
# http://www.granneman.com/webdev/coding/css/centertables/
print(xtable(percentMissingTableData),
      type="html",
      include.rownames=FALSE,
      html.table.attributes="class='table-bordered'")
```
  
## Issue Category Percentage
```{r eda1, echo=FALSE, results='asis'}
summaryIssueCategoryPercentage <-
    initializeSummaryIssueCategoryPercentage(trainingData)

topFiveIssueCategories <- summaryIssueCategoryPercentage[1:5,
                                                         c("issuecategory")]
```
- Results suggest that `r topFiveIssueCategories[1]`, 
`r topFiveIssueCategories[2]`, `r topFiveIssueCategories[3]`, 
`r topFiveIssueCategories[4]`, & `r topFiveIssueCategories[5]` are the top five
consumer complaint issue categories
  
```{r eda2, echo=FALSE, results='asis'}
print(xtable(summaryIssueCategoryPercentage),
      type="html",
      include.rownames=FALSE,
      html.table.attributes="class='table-bordered'")
```

## Percentage of Mortgage Category Complaints
```{r eda3, echo=FALSE}
stateIssueCategoryPercentage <-
    computeStateIssueCategoryPercentage(trainingData)

mortgagePercentage <- initializePercentIssue("mortgage",
                                             stateIssueCategoryPercentage,
                                             state.regions)

stateSubmittedViaPercentage <-
    computeStateSubmittedViaPercentage(trainingData)
```
- Percentage of mortage related consumer complaints for each U.S. state 
[choropleth](http://blog.crisis.net/choropleth-maps-with-d3/)
  
```{r eda4, echo=FALSE}
library(choroplethr)
library(choroplethrMaps)
library(ggplot2)
library(RColorBrewer)
# http://cran.r-project.org/web/packages/choroplethr/vignettes/
#   b-state-choropleth.html
choro = StateChoropleth$new(mortgagePercentage)
choro$title <- "Percentage of Mortgage Complaints"
choro$ggplot_scale = scale_fill_brewer(palette="PuBuGn")
choro$render()
```

## Perecent of Debt Collection Category Complaints
- Percentage of debt collection related consumer complaints for each U.S. state 
  
```{r eda5, echo=FALSE}
debtCollectionPercentage <-
    initializePercentIssue("debtcollection",
                           stateIssueCategoryPercentage,
                           state.regions)

choro = StateChoropleth$new(debtCollectionPercentage)
choro$title <- "Percentage of Debt Collection Complaints"
choro$ggplot_scale = scale_fill_brewer(palette="YlGnBu")
choro$render()
```