---
title: "CFPB Consumer Complaint Database Exploratory Data Analysis"
author: mspcvsp
date: 05/01/15
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    css: styles.css
---

## Introduction
```{r setupEnvironment, echo=FALSE, warning=FALSE, message=FALSE}

# http://stackoverflow.com/questions/18931006/
#   how-to-suppress-warning-messages-when-loading-a-library
suppressWarnings(library(dplyr))
suppressWarnings(library(Gmisc))

library(caret)
library(choroplethr)
library(choroplethrMaps)
library(data.table)
library(ggmap)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(zipcode)

data(state.regions)

source("./dataCleaning.R")
source("./dataAnalysis.R")
set.seed(58978160)

dataDirectory <- "./Data"
analyticDataPath <- "./AnalyticData"
maximumPercentMissing <- 10.0

if (is.na(file.info(dataDirectory)[1,"isdir"])) {
    downloadData(dataDirectory)
}

if (is.na(file.info(file.path(analyticDataPath,
                              "/trainingData.csv"))[1,"size"])) {
    createAnalyticDataset(dataDirectory,
                          maximumPercentMissing,
                          analyticDataPath)
}

trainingData <- loadAnalyticData(analyticDataPath,
                                 "trainingData.csv")

dbDataStatistics <- loadDataStatistics(analyticDataPath)

dbVariables <- initializeVariables(dbDataStatistics)
```
   
- [Consumer Financial Protection Bureau (CFPB)](http://www.consumerfinance.gov/)
[Consumer Complaint Database](https://catalog.data.gov/dataset/consumer-complaint-database)
    * Number of complaints: `r dbDataStatistics$numberobservations`  
    * Number of variables: `r length(dbVariables)`  
    * Number of companies: `r dbDataStatistics$numbercompanies`  
    * Number of unique complaint issues: `r dbDataStatistics$numberissues`
    * Data retrieved from [Data.gov](https://www.data.gov/)  
  
- Topics covered in this presentation
    * Data cleaning
    * Visualization of state-level statistics via [chroopleths](https://github.com/trulia/choroplethr)
    * Plotting zipcode-level statistics using the [ggmap package](http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf)

## Data Cleaning {.columns-2}
- 1.) Transform the variable names to lower case
- 2.) Remove '.' from variale names
- 3.) Remove U.S. states & territories outside of the continental U.S.
- 4.) Apply a maximum percent missing threshold to remove partial observations
- 5.) Remove whitespace from the company type
- 6.) For each database variable:
    * Transform to lower case
    * Remove apostrophe (e.g. change cont'd to contd)
    * Remove punctuation
    * Replace multiple spaces with a single space
- 7.) Remove white space from the company type
- 8.) Aggregate the complaint issues into categories
- 9.) Remove the "other" category
- 10.) Append city, state, latitude, & lognitude
- 11.) Add a companyid variable
- 12.) Convert date variables
- 13.) Convert factor variables

## Percent Missing Data
```{r initializePercentMissingTable, echo=FALSE}
percentMissingTableData <- initializePercentMissingDataTable(dbDataStatistics)
```
- Results suggest `r sum(percentMissingTableData[,2] > maximumPercentMissing)`
variables exceed the maximum percentage of missing data threshold of
`r maximumPercentMissing` %.  
  
```{r displayPercentMissingTable, echo=FALSE, results='asis'}
library(xtable)
# Technical references:
# -------------------
# http://stackoverflow.com/questions/20200082/formatting-html-table-in-r
#
# http://stackoverflow.com/questions/21291762/
#   css-how-to-define-a-class-for-table-to-control-the-style-of-table-rows
#
# http://www.w3schools.com/css/css_table.asp
#
# http://cssmenumaker.com/blog/stylish-css-tables-tutorial
#
# http://stackoverflow.com/questions/5430338/
#   remove-data-frame-row-names-when-using-xtable
#
# http://www.granneman.com/webdev/coding/css/centertables/
print(xtable(percentMissingTableData),
      type="html",
      include.rownames=FALSE,
      html.table.attributes="class='table-bordered'")
```